{% extends "auctions/layout.html" %}

{% block body %}
<!-- Status Alerts -->
{% if not listing.is_active %}
<div class="alert alert-secondary alert-permanent" role="alert" data-aos="fade-down">
    <strong>This auction is closed.</strong>
</div>

{% if is_winner %}
<div class="alert alert-success alert-permanent" role="alert" data-aos="fade-down" data-aos-delay="100">
    <strong>Congratulations!</strong> You won this auction.
</div>
{% endif %}
{% endif %}

{% if error_message %}
<div class="alert alert-danger" role="alert" data-aos="fade-down">
    {{ error_message }}
</div>
{% endif %}

<!-- Listing Detail -->
<div class="row">
    <div class="col-lg-6" data-aos="fade-right">
        <div class="detail-section">
            <img src="{{ listing.image_url }}" alt="{{ listing.title }}" class="listing-detail-image" onerror="this.src='https://via.placeholder.com/500x500?text=No+Image'">
        </div>
    </div>

    <div class="col-lg-6" data-aos="fade-left">
        <div class="detail-section">
            <h2>{{ listing.title }}</h2>
            <p style="color: var(--gray-600); margin-top: 1rem; line-height: 1.7;">{{ listing.description }}</p>

            <h5 style="margin-top: 2rem; margin-bottom: 1.5rem; color: var(--dark);">Details</h5>
            <ul class="info-list">
                <li>
                    <span class="info-label">Status</span>
                    <span class="info-value">
                        {% if listing.is_active %}
                        <span class="badge badge-success">Active</span>
                        {% else %}
                        <span class="badge badge-secondary">Closed</span>
                        {% endif %}
                    </span>
                </li>
                <li>
                    <span class="info-label">Category</span>
                    <span class="info-value">{{ listing.category }}</span>
                </li>
                <li>
                    <span class="info-label">Starting Bid</span>
                    <span class="info-value">${{ listing.starting_bid }}</span>
                </li>
                <li>
                    <span class="info-label">Current Bid</span>
                    <span class="info-value" style="font-weight: 700; color: var(--primary-color);" data-current-bid="{{ listing.highest_bid }}">${{ listing.highest_bid }}</span>
                </li>
                <li>
                    <span class="info-label">Seller</span>
                    <span class="info-value">{{ listing.owner }}</span>
                </li>
            </ul>

            {% if not is_owner and user.is_authenticated %}
            <form method="post" action="{% url 'toggle_watchlist' listing.id %}" style="margin-top: 2rem;">
                {% csrf_token %}
                <button type="submit" class="btn btn-secondary" data-watchlist-toggle style="width: 100%;">
                    {% if user in listing.watchers.all %}
                    Remove from Watchlist
                    {% else %}
                    Add to Watchlist
                    {% endif %}
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<!-- Bidding Section -->
{% if listing.is_active and not is_owner and user.is_authenticated %}
<div class="detail-section" data-aos="fade-up">
    <h4>Place Your Bid</h4>
    <form method="post" class="formBid">
        {% csrf_token %}
        <div class="form-group">
            <div style="display: flex; gap: 1rem; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="bid">Bid Amount</label>
                    <input type="number" name="bid" id="bid" step="0.01" class="form-control" placeholder="Enter amount" required>
                    <small style="color: var(--gray-500); display: block; margin-top: 0.5rem;">
                        Minimum bid: ${{ listing.highest_bid}}
                    </small>
                </div>
                <button type="submit" name="bid_button" class="btn btn-primary">Place Bid</button>
            </div>
        </div>
    </form>
</div>
{% endif %}

<!-- Close Auction (Owner Only) -->
{% if is_owner and listing.is_active %}
<div class="detail-section" data-aos="fade-up">
    <form method="post">
        {% csrf_token %}
        <button type="submit" name="close" class="btn btn-danger">Close Auction</button>
    </form>
</div>
{% endif %}

<!-- Comments Section -->
<div class="comments-section" data-aos="fade-up">
    <h3>Comments</h3>
    
    {% if comments %}
    <div style="margin: 1.5rem 0;">
        {% for comment in comments %}
        <div class="comment-item" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:'0' }}0">
            <div class="comment-author">{{ comment.author }}</div>
            <div class="comment-content">{{ comment.content }}</div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: var(--gray-500); margin: 1rem 0;">No comments yet. Be the first to comment!</p>
    {% endif %}

    {% if user.is_authenticated %}
    <h4 style="margin-top: 2rem;">Add a Comment</h4>
    <form method="post" class="formComment">
        {% csrf_token %}
        <div class="form-group">
            <textarea name="comment" class="form-control" rows="3" placeholder="Share your thoughts..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Post Comment</button>
    </form>
    {% else %}
    <p style="color: var(--gray-500); margin-top: 2rem;">
        <a href="{% url 'login' %}" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">Log in</a> to leave a comment.
    </p>
    {% endif %}
</div>

{% endblock %}